# –ú–∏–≥—Ä–∞—Ü–∏—è: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞.

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –ø–æ Telegram ID –ø—Ä—è–º–æ –∏–∑ –±–æ—Ç–∞
- üóë –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –ë–î
- üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ (.env + –ë–î)
- üë®‚Äçüíº –†–∞–∑–¥–µ–ª "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã" –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
```sql
CREATE TABLE admins (
    id VARCHAR(36) PRIMARY KEY,
    telegram_id BIGINT NOT NULL UNIQUE,
    username VARCHAR(255),
    full_name VARCHAR(255),
    is_active BOOLEAN NOT NULL DEFAULT 1,
    access_level BIGINT NOT NULL DEFAULT 1,
    added_by_id BIGINT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME
);
```

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### ‚≠ê –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç –í–°–ï –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

```bash
cd ~/Lead_bot
git pull origin main
bash migrate_all.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç `telegram_file_id` –≤ `lead_magnets`
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `admins`
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å

### –í–∞—Ä–∏–∞–Ω—Ç 2: Python —Å–∫—Ä–∏–ø—Ç

```bash
cd ~/Lead_bot
python3 scripts/create_admins_table.py
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ SQLite

```bash
cd ~/Lead_bot
sqlite3 leadbot.db <<EOF
CREATE TABLE IF NOT EXISTS admins (
    id VARCHAR(36) PRIMARY KEY,
    telegram_id BIGINT NOT NULL UNIQUE,
    username VARCHAR(255),
    full_name VARCHAR(255),
    is_active BOOLEAN NOT NULL DEFAULT 1,
    access_level BIGINT NOT NULL DEFAULT 1,
    added_by_id BIGINT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME
);

CREATE INDEX IF NOT EXISTS ix_admins_telegram_id ON admins(telegram_id);
EOF
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```bash
sqlite3 leadbot.db "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É `admins` –≤ —Å–ø–∏—Å–∫–µ.

## üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
systemctl restart leadbot
# –∏–ª–∏
supervisorctl restart leadbot
# –∏–ª–∏
pkill -f "python.*main.py" && nohup python3 main.py &
```

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
journalctl -u leadbot -f
# –∏–ª–∏
tail -f logs/leadbot*.log
```

–û—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å:
- ‚úÖ `no such table: admins`
- ‚úÖ `no such column: lead_magnets.telegram_file_id`

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞
2. `/admin` ‚Üí "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"
3. –ù–∞–∂–º–∏—Ç–µ "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
4. –í–≤–µ–¥–∏—Ç–µ Telegram ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞
5. –ì–æ—Ç–æ–≤–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/admin`

### –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:

1. `/admin` ‚Üí "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"
2. –ù–∞–∂–º–∏—Ç–µ "üóë –£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
3. –í–≤–µ–¥–∏—Ç–µ Telegram ID –∞–¥–º–∏–Ω–∞
4. –ê–¥–º–∏–Ω —É–¥–∞–ª–µ–Ω (—Ç–æ–ª—å–∫–æ –∏–∑ –ë–î, –Ω–µ –∏–∑ .env)

### –ö–∞–∫ —É–∑–Ω–∞—Ç—å Telegram ID:

1. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot
2. –û–Ω –ø—Ä–∏—à–ª–µ—Ç –≤–∞—à ID
3. –ò–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø–∏—Å–∞—Ç—å –≤–∞—à–µ–º—É –±–æ—Ç—É /start
4. ID –ø–æ—è–≤–∏—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

## üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–∏—Å—Ç–µ–º–∞ –¥–≤—É—Ö —É—Ä–æ–≤–Ω–µ–π:

1. **–ê–¥–º–∏–Ω—ã –∏–∑ .env** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `.env`
   - –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
   - –í—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø
   - –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è: `ADMIN_IDS=1670311707,987654321`

2. **–ê–¥–º–∏–Ω—ã –∏–∑ –ë–î**:
   - –î–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
   - –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `admins`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:

–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –û–ë–ê –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
```python
# –°–Ω–∞—á–∞–ª–∞ .env
if user_id in settings.admin_ids_list:
    return True

# –ü–æ—Ç–æ–º –ë–î
admin = await admin_service.get_admin_by_telegram_id(user_id)
if admin and admin.is_active:
    return True
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

- –ê–¥–º–∏–Ω—ã –∏–∑ .env **–Ω–µ–ª—å–∑—è** —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ê–¥–º–∏–Ω –Ω–µ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å–∞–º —Å–µ–±—è
- –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ –∏–∑ –ë–î = –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è (–Ω–µ –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
- –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL –Ω–∞–ø—Ä—è–º—É—é

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "no such table: admins"

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
bash migrate_all.sh
```

### –û—à–∏–±–∫–∞: "cannot import name 'async_sessionmaker'"

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –±–µ–∑ Python:
```bash
bash migrate_all.sh
```

### –¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ, –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã admins

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | VARCHAR(36) | UUID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ |
| telegram_id | BIGINT | Telegram ID (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| username | VARCHAR(255) | Username –≤ Telegram |
| full_name | VARCHAR(255) | –ü–æ–ª–Ω–æ–µ –∏–º—è |
| is_active | BOOLEAN | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∞–¥–º–∏–Ω |
| access_level | BIGINT | –£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ (1-100) |
| added_by_id | BIGINT | –ö—Ç–æ –¥–æ–±–∞–≤–∏–ª –∞–¥–º–∏–Ω–∞ |
| created_at | DATETIME | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | DATETIME | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞ —á–µ—Ä–µ–∑ Python:

```python
from app.core.database import get_db_session
from app.services.admin_service import AdminService

async with get_db_session() as session:
    admin_service = AdminService(session)
    await admin_service.add_admin(
        telegram_id=123456789,
        username="new_admin",
        full_name="–ù–æ–≤—ã–π –ê–¥–º–∏–Ω",
        added_by_id=1670311707
    )
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞:

```python
from app.bot.utils import is_admin

if await is_admin(user_id):
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω
    pass
```

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤:

```python
from app.bot.utils import get_all_admin_ids

admin_ids = await get_all_admin_ids()
# –í–µ—Ä–Ω–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑ .env + –ë–î
```

## üì¶ –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–∏

- `migrate_all.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (bash)
- `scripts/create_admins_table.py` - Python —Å–∫—Ä–∏–ø—Ç
- `migration.sql` - SQL —Å–∫—Ä–∏–ø—Ç
- `MIGRATION_ADMINS.md` - —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

